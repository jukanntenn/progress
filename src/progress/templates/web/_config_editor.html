{% if current_language %}
{% set lang = current_language %}
{% else %}
{% set lang = 'en' %}
{% endif %}

{% if current_timezone %}
{% set tz = current_timezone %}
{% else %}
{% set tz = 'UTC' %}
{% endif %}

<div id="section-general" class="config-section">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        General Settings
    </h3>

    <div class="mb-5">
        <label for="ctrl-language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Language
        </label>
        <select id="ctrl-language" data-path="language"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
            <option value="zh-hans" {% if lang == 'zh-hans' %}selected{% endif %}>简体中文</option>
        </select>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Select your preferred interface language for the web UI</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-timezone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Timezone
        </label>
        <div class="relative">
            <input type="text" id="ctrl-timezone" data-path="timezone" autocomplete="off"
                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Search timezone..." value="{{ tz }}">
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Select your timezone for scheduling and timestamp display</p>
    </div>
</div>

<div id="section-markpost" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        Markpost Settings
    </h3>

    <div class="mb-5">
        <label for="ctrl-markpost-url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Markpost URL
        </label>
        <input type="url" id="ctrl-markpost-url" data-path="markpost.url"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="https://example.com/api/base_url/post_key">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Full Markpost API URL including base_url and post_key (e.g., https://example.com/api/base_url/post_key)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-markpost-timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Timeout
        </label>
        <input type="number" id="ctrl-markpost-timeout" data-path="markpost.timeout"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="30" min="1">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">HTTP request timeout in seconds. Increase this if you experience timeout issues (default: 30)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-markpost-max-batch-size" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Max Batch Size
        </label>
        <input type="number" id="ctrl-markpost-max-batch-size" data-path="markpost.max_batch_size"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="1048576" min="1">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="markpost.max_batch_size">
            
            <span>Maximum batch size for uploads in bytes (default: 1048576)</span>
        </div>
    </div>
</div>

<div id="section-notification" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        Notification Channels
    </h3>

    <div id="notification-channels-list" class="flex flex-col gap-3 mb-4">
        <p class="text-sm text-gray-500 dark:text-gray-400">No channels configured yet.</p>
    </div>

    <div class="flex gap-2">
        <button onclick="openAddFeishuModal()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
            Add Feishu
        </button>
        <button onclick="openAddEmailModal()" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
            Add Email
        </button>
    </div>
</div>

<div id="section-github" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        GitHub Settings
    </h3>

    <div class="mb-5">
        <label for="ctrl-github-token" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            GitHub Token
        </label>
        <div class="relative">
            <input type="password" id="ctrl-github-token" data-path="github.gh_token"
                class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                placeholder="ghp_xxxxxxxxxxxx">
            <button type="button" onclick="togglePasswordVisibility('ctrl-github-token')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                
            </button>
        </div>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">GitHub personal access token for API access. Create one at: github.com/settings/tokens</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-github-protocol" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Protocol
        </label>
        <select id="ctrl-github-protocol" data-path="github.protocol"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="https">https</option>
            <option value="ssh">ssh</option>
        </select>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Protocol to use for Git operations. HTTPS works with most networks, SSH requires key setup (default: https)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-github-proxy" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Proxy
        </label>
        <input type="text" id="ctrl-github-proxy" data-path="github.proxy"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="http://127.0.0.1:7890 or socks5://127.0.0.1:1080">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Proxy server for Git and GitHub CLI operations. Use format: http://host:port or socks5://host:port (optional)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-github-git-timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Git Timeout
        </label>
        <input type="number" id="ctrl-github-git-timeout" data-path="github.git_timeout"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="300" min="1">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="github.git_timeout">
            
            <span>Git command timeout in seconds (default: 300)</span>
        </div>
    </div>

    <div class="mb-5">
        <label for="ctrl-github-gh-timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            GitHub CLI Timeout
        </label>
        <input type="number" id="ctrl-github-gh-timeout" data-path="github.gh_timeout"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="300" min="1">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="github.gh_timeout">
            
            <span>GitHub CLI command timeout in seconds (default: 300)</span>
        </div>
    </div>
</div>

<div id="section-analysis" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        AI Analysis Settings
    </h3>

    <div class="mb-5">
        <label for="ctrl-analysis-max-diff-length" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Max Diff Length
        </label>
        <input type="number" id="ctrl-analysis-max-diff-length" data-path="analysis.max_diff_length"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="100000" min="1">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Maximum diff length in characters to send for AI analysis. Larger diffs may be truncated (default: 100000)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-analysis-concurrency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Concurrency
        </label>
        <input type="number" id="ctrl-analysis-concurrency" data-path="analysis.concurrency"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="1" min="1">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Number of concurrent analysis tasks. Increase for faster processing on powerful machines, or use 1 for serial processing (default: 1)</p>
    </div>

    <div class="mb-5">
        <label for="ctrl-analysis-timeout" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Timeout
        </label>
        <input type="number" id="ctrl-analysis-timeout" data-path="analysis.timeout"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="600" min="1">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="analysis.timeout">
            
            <span>Analysis timeout in seconds</span>
        </div>
    </div>

    <div class="mb-5">
        <label for="ctrl-analysis-language" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Language
        </label>
        <input type="text" id="ctrl-analysis-language" data-path="analysis.language"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="en">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Language for AI-generated analysis reports. Supports common language codes like en, zh, ja, ko (default: en)</p>
    </div>
</div>

<div id="section-web" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        Web Service Settings
    </h3>

    <div class="mb-5">
        <label class="flex items-center">
            <input type="checkbox" id="ctrl-web-enabled" data-path="web.enabled" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Enable Web Service</span>
        </label>
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="web.enabled">
            
            <span>Enable the web interface</span>
        </div>
    </div>

    <div class="mb-5">
        <label for="ctrl-web-host" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Host
        </label>
        <input type="text" id="ctrl-web-host" data-path="web.host"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="0.0.0.0">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="web.host">
            
            <span>Host address to bind to</span>
        </div>
    </div>

    <div class="mb-5">
        <label for="ctrl-web-port" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            Port
        </label>
        <input type="number" id="ctrl-web-port" data-path="web.port"
            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="5000" min="1" max="65535">
        <div class="comment-help mt-1 text-xs text-gray-500 dark:text-gray-400" data-help-for="web.port">
            
            <span>Port number to listen on</span>
        </div>
    </div>
</div>

<div id="section-repos" class="config-section hidden">
    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
        Repositories
    </h3>

    <div id="repos-list" class="flex flex-col gap-3 mb-4">
        <p class="text-sm text-gray-500 dark:text-gray-400">No repositories configured yet.</p>
    </div>

    <button onclick="openAddRepoModal()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
        Add Repository
    </button>
</div>

<script>
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.nextElementSibling;
        const icon = button.querySelector('i');

        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fa-solid fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fa-solid fa-eye';
        }
    }
</script>
